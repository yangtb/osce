<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.osce.orm.biz.show.PfShowDao">

    <select id="selectBigScreenMain" resultType="com.osce.vo.biz.show.ShowBigScreenMainVo">
        SELECT
            v.id_plan, v.id_area, v.time_section,
            b.na_org ,
            v.na_plan ,
            if(v.fg_replan = 0 , '普考' , '补考') as fgReplan,
            c.na_area ,
            v.plan_day ,
            date_format(v.time_begin , '%H:%i') time_begin ,
            date_format(v.time_end , '%H:%i') time_end
        FROM
            sys_org b
        LEFT JOIN v_we_show_main v ON v.id_org = b.id_org AND plan_day = DATE(NOW())
        <if test="amPmFlag == 0">
            AND v.time_begin &lt;= '12:00:00'
        </if>
        <if test="amPmFlag == 1">
            AND v.time_begin > '12:00:00'
        </if>
        LEFT JOIN td_area c ON v.id_area = c.id_area
        WHERE
            b.id_org = #{idOrg}
        LIMIT 1
    </select>
    <select id="selectBigScreenDetail" resultType="com.osce.vo.biz.show.ShowBigScreenDetailVo">
        SELECT
            @rownum :=@rownum + 1 rownum ,
            v.user_cd ,
            v.real_name ,
            concat(c.na_station , '（' ,b.na_room, '）') AS siteName ,
            v.statusNum ,
            v.status
        FROM
            (SELECT @rownum := 0) r ,
            v_we_show_detail v
        LEFT JOIN td_site a ON v.site = a.id_site
        LEFT JOIN erp_room b ON a.id_room = b.id_room
        LEFT JOIN td_station c ON a.id_station = c.id_station
        WHERE
            v.id_plan = #{idPlan}
        AND v.id_area = #{idArea}
        AND v.time_section = #{timeSection}
        ORDER BY
            v.id_ins_station_detail
        limit #{offset}, #{limit}
    </select>
    <select id="countBigScreenDetail" resultType="java.lang.Long">
        SELECT
            count(1)
        FROM
            v_we_show_detail v
        WHERE
            v.id_plan = #{idPlan}
        AND v.id_area = #{idArea}
        AND v.time_section = #{timeSection}
    </select>
    <select id="listAioMain" resultType="com.osce.vo.biz.show.ShowAioMainVo">
        SELECT
            v.id_plan, v.id_area, v.time_section,
            v.na_plan ,
            if(v.fg_replan = 0 , '普考' , '补考') as fgReplan,
            c.na_area ,
            v.sd_plan_status,
            CONCAT('第',floor(v.time_section),'天',(CASE WHEN((v.time_section - floor(v.time_section)) = 0 ) THEN '上午' ELSE '下午' END)) AS planTime,
            v.plan_day ,
            date_format(v.time_begin , '%H:%i') time_begin ,
            date_format(v.time_end , '%H:%i') time_end
        FROM
            v_we_show_main v
        LEFT JOIN td_area c ON v.id_area = c.id_area
        WHERE
            v.id_org = #{idOrg}
        and v.sd_plan_status in (2, 3, 4)
        ORDER BY
            plan_day ,
            time_section
    </select>
    <select id="aioStudentRegister" statementType="CALLABLE">
         call P_WAITING_REG(
            #{parIdPlan,mode=IN,jdbcType=INTEGER},
            #{parIdArea,mode=IN,jdbcType=INTEGER},
            #{parTimeSection,mode=IN,jdbcType=FLOAT},
            #{parIdCard,mode=IN,jdbcType=VARCHAR},
            #{parCode,mode=OUT,jdbcType=INTEGER},
            #{parMsg,mode=OUT,jdbcType=VARCHAR}
        )
    </select>
    <select id="listAioRegistered" resultType="com.osce.vo.biz.show.ShowAioRegisteredVo">
        SELECT
            a.id_waiting_reg ,
            b.real_name ,
            a.no_reg ,
            b.phone_no ,
            CONCAT(LEFT(b.idcard,2), '**************', RIGHT(b.idcard,2)) as idcard ,
            date_format(a.gmt_reg , '%H:%i:%s') as gmt_reg,
            d.id_student_depart AS user_id
        FROM
            we_waiting_reg a
        LEFT JOIN org_student_depart d ON a.id_user_student = d.id_student_depart
        LEFT JOIN user_info b ON d.id_user = b.user_id
        WHERE
            a.id_org = #{idOrg}
        AND a.id_plan = #{idPlan}
        AND a.id_area = #{idArea}
        AND a.time_section = #{timeSection}
    </select>
    <select id="listAioExecQueue" resultType="com.osce.vo.biz.show.ShowAioExecQueueVo">
        SELECT
            a.id_exec_queue ,
            b.na_station ,
            c.na_room ,
            a.sd_skill_ca ,
            a.id_paper ,
            date_format(a.plan_begin , '%H:%i') plan_begin ,
            date_format(a.plan_end , '%H:%i') plan_end
        FROM
            es_exec_queue a
        LEFT JOIN td_station b ON a.id_station = b.id_station
        LEFT JOIN erp_room c ON a.id_room = c.id_room
        WHERE
            a.id_org = #{idOrg}
        AND a.id_plan = #{idPlan}
        AND a.id_area = #{idArea}
        AND a.time_section = #{timeSection}
        AND a.id_user_student = #{idUserStudent}
    </select>
    <select id="selectStationRoomInfo" resultType="com.osce.vo.biz.show.ShowStationVo">
        SELECT
            na_station ,
            (SELECT dict_name from sys_dictionary where group_code = 'SD_STATION_CA' and dict_code = sd_station_ca) AS sdStationCaText ,
            sd_skill_ca ,
            na_paper ,
            des_paper ,
            min_cost ,
            fg_must ,
            num_concur
        FROM
            v_es_get_site_infor
        WHERE
            id_plan = #{idPlan}
        AND id_area = #{idArea}
        AND time_section = #{timeSection}
        AND id_room = #{idRoom}
    </select>
    <select id="listRoomStudent" resultType="com.osce.vo.biz.show.ShowRoomStudentVo">
        SELECT
            queue.id_user_student ,
            queue.cd_student ,
            user.real_name ,
            user.phone_no ,
            user.idcard ,
            user.user_cd ,
            queue.plan_begin ,
            queue.plan_end ,
            queue.sd_exec_queue ,
            queue.act_begin ,
            DATE_ADD(queue.act_begin , INTERVAL queue.min_cost MINUTE) as countdownTime ,
            queue.act_end
        FROM
            es_exec_queue queue
        JOIN user_info user ON queue.id_user_student = user.user_id
        WHERE
            queue.id_plan = #{idPlan}
        AND queue.id_area =  #{idArea}
        AND queue.time_section = #{timeSection}
        AND queue.id_room = #{idRoom}
        AND queue.sd_exec_queue &lt;= 4
        limit #{limit}
    </select>
    <select id="countRoomStudent" resultType="java.lang.Integer">
        SELECT
            count(1)
        FROM
            es_exec_queue queue
        WHERE
            queue.id_plan = #{idPlan}
        AND queue.id_area =  #{idArea}
        AND queue.time_section = #{timeSection}
        AND queue.id_room = #{idRoom}
        AND queue.sd_exec_queue = 1
    </select>
    <select id="selectNoReg" resultType="java.lang.Integer">
        SELECT
            a.no_reg
        FROM
            we_waiting_reg a
        WHERE
            a.id_org = #{idOrg}
        AND a.id_plan = #{parIdPlan}
        AND a.id_area = #{parIdArea}
        AND a.time_section = #{parTimeSection}
        AND a.id_user_student = #{userId}
        limit 1
    </select>
    <select id="countRegisterNum" resultType="java.lang.Integer">
        SELECT
            count(1)
        FROM
            we_waiting_reg
        WHERE
            id_org = #{idOrg}
        AND id_plan = #{idPlan}
        AND id_area = #{idArea}
        AND time_section = #{timeSection}
    </select>
    <select id="countStuTotalNum" resultType="java.lang.Integer">
        SELECT
            count(1)
        FROM
            tp_student
        WHERE
            id_plan = #{idPlan}
    </select>

</mapper>